<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>پیش فاکتور فروش</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:1000px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px}
input,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #ccc}
button{background:#7b2cbf;color:#fff;border:none;cursor:pointer}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;border-radius:6px;margin-top:10px}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.print-only{display:none}
.small-btn{background:#aaa;font-size:12px}

@media print{
  .no-print{display:none}
  .print-only{display:block}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>
<body>

<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>پیش فاکتور فروش</h2>

<div class="row no-print">
  <div><input id="area" placeholder="متراژ"></div>
  <div><input id="pricePerMeter" class="money" placeholder="قیمت هر متر"></div>
</div>

<input id="total" class="money" placeholder="مبلغ کل اولیه" readonly>

<div class="row no-print">
  <div><input id="discountPercent" placeholder="تخفیف درصدی"></div>
  <div><input id="discountAmount" class="money" placeholder="تخفیف مبلغی"></div>
</div>

<div class="box no-print">
<b>واریزهای نقدی</b>
<table>
<thead><tr><th>مبلغ</th><th>تاریخ</th><th></th></tr></thead>
<tbody id="cashRows"></tbody>
</table>
<button onclick="addCash()">➕ افزودن واریز نقدی</button>
</div>

<div class="row no-print">
  <div><input id="doc" class="money" placeholder="سند"></div>
  <div><input id="delivery" class="money" placeholder="تحویل"></div>
</div>

<div class="row no-print">
  <div><input id="count" placeholder="تعداد اقساط"></div>
  <div><input id="gap" placeholder="فاصله اقساط (ماه)"></div>
</div>

<button onclick="calc()" class="no-print">محاسبه</button>

<div id="summary" class="box bold"></div>

<table>
<thead><tr><th>قسط</th><th>مبلغ</th><th>تاریخ</th></tr></thead>
<tbody id="installments"></tbody>
<tfoot><tr><th>جمع اقساط</th><th colspan="2" id="sumInstallments"></th></tr></tfoot>
</table>

</div>

<script>
setInterval(()=>{
 const d=new Date();
 date.textContent=d.toLocaleDateString('fa-IR');
 time.textContent=d.toLocaleTimeString('fa-IR');
},1000);

document.addEventListener('input',e=>{
 if(!e.target.classList.contains('money'))return;
 let v=e.target.value.replace(/,/g,'').replace(/\D/g,'');
 e.target.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,",");
});

function num(id){
 return Number((document.getElementById(id).value||'').replace(/,/g,''))||0;
}

area.oninput=pricePerMeter.oninput=()=>{
 total.value=(Number(area.value||0)*num('pricePerMeter')).toLocaleString();
};

function addCash(){
 cashRows.innerHTML+=`
 <tr>
  <td><input class="money cashAmount"></td>
  <td><input type="date"></td>
  <td><button class="small-btn" onclick="this.closest('tr').remove()">✖</button></td>
 </tr>`;
}

function getCashTotal(){
 let s=0;
 document.querySelectorAll('.cashAmount').forEach(i=>{
  s+=Number(i.value.replace(/,/g,''))||0;
 });
 return s;
}

function daysInMonth(jy,jm){
 if(jm<=6)return 31;
 if(jm<=11)return 30;
 return (jy%4===3)?30:29;
}

function addMonths(jy,jm,jd,m){
 jm+=m; jy+=Math.floor((jm-1)/12);
 jm=((jm-1)%12)+1;
 let dim=daysInMonth(jy,jm);
 if(jd>dim)jd=dim;
 return `${jy}/${String(jm).padStart(2,'0')}/${String(jd).padStart(2,'0')}`;
}

function calc(){
 const totalInitial=Number(area.value||0)*num('pricePerMeter');
 const afterDiscount=totalInitial-
  (totalInitial*(num('discountPercent')/100))-
  num('discountAmount');

 const net=afterDiscount-(getCashTotal()+num('doc')+num('delivery'));
 const countVal=Number(count.value)||1;
 const gapVal=Number(gap.value)||1;
 const base=net/countVal;

 installments.innerHTML='';
 let sum=0;

 const now=new Date();
 const j=jalaali.toJalaali(now.getFullYear(),now.getMonth()+1,now.getDate());

 for(let i=1;i<=countVal;i++){
  let inst=Math.round(base);
  sum+=inst;
  let d=addMonths(j.jy,j.jm,j.jd,i*gapVal);
  installments.innerHTML+=`<tr><td>${i}</td><td>${inst.toLocaleString()}</td><td>${d}</td></tr>`;
 }

 sumInstallments.textContent=sum.toLocaleString();
 summary.textContent=`مبلغ کل بعد از تخفیف: ${afterDiscount.toLocaleString()} تومان
مبلغ قابل تقسیط: ${net.toLocaleString()} تومان`;
}
</script>

</body>
</html>
