<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</title>

<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:950px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px}
input,button{width:100%;padding:8px;margin:5px 0;font-size:14px;border-radius:6px;border:1px solid #ccc}
button{background:#7b2cbf;color:#fff;border:none;cursor:pointer}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.print-only{display:none}
.small-btn{background:#999;font-size:12px}

@media print{
  .no-print{display:none}
  .print-only{display:block}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>

<body>

<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h2>

<div class="row no-print">
  <div><input id="area" placeholder="Ù…ØªØ±Ø§Ú˜"></div>
  <div><input id="pricePerMeter" class="money" placeholder="Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±"></div>
</div>

<input id="total" class="money no-print" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡" readonly>

<div class="row no-print">
  <div><input id="discountPercent" placeholder="ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ"></div>
  <div><input id="discountAmount" class="money" placeholder="ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ"></div>
</div>

<!-- ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ -->
<div class="box no-print">
<b>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ</b>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th></th></tr></thead>
<tbody id="cashRows"></tbody>
</table>
<button onclick="addCash()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ</button>
</div>

<div class="row no-print">
  <div><input id="doc" class="money" placeholder="Ø³Ù†Ø¯"></div>
  <div><input id="delivery" class="money" placeholder="ØªØ­ÙˆÛŒÙ„"></div>
</div>

<div class="row no-print">
  <div><input id="count" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·"></div>
  <div><input id="gap" placeholder="ÙØ§ØµÙ„Ù‡ Ø§Ù‚Ø³Ø§Ø· (Ù…Ø§Ù‡)"></div>
</div>

<input id="percent" class="no-print" placeholder="Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø§Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
<button onclick="calc()" class="no-print">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
<button onclick="window.print()" class="no-print">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>

<div id="summary" class="box bold"></div>

<table>
<thead><tr><th>Ù‚Ø³Ø·</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
<tbody id="installments"></tbody>
<tfoot><tr><th>Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø·</th><th colspan="2" id="sumInstallments"></th></tr></tfoot>
</table>

<!-- Ù¾Ø±ÛŒÙ†Øª -->
<div class="box print-only">
<h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
<b>Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡:</b> <span id="pInitial"></span><br>
<b>Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ø² ØªØ®ÙÛŒÙ:</b> <span id="pAfterDiscount"></span><br>

<h4>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ</h4>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
<tbody id="pCashRows"></tbody>
</table>

<b>Ø³Ù†Ø¯:</b> <span id="pDoc"></span><br>
<b>ØªØ­ÙˆÛŒÙ„:</b> <span id="pDelivery"></span><br>
<b>Ù…Ø¨Ù„Øº Ú©Ù„ Ø¬Ø¯ÛŒØ¯:</b> <span id="pNewTotal"></span><br>

<h4>Ø§Ù‚Ø³Ø§Ø·</h4>
<table>
<thead><tr><th>Ù‚Ø³Ø·</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
<tbody id="pInstallments"></tbody>
<tfoot><tr><th>Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø·</th><th colspan="2" id="pSum"></th></tr></tfoot>
</table>
</div>

</div>

<script>
setInterval(()=>{
  const d=new Date();
  time.textContent=d.toLocaleTimeString('fa-IR');
  date.textContent=d.toLocaleDateString('fa-IR');
},1000);

document.addEventListener('input',e=>{
  if(!e.target.classList.contains('money'))return;
  let v=e.target.value.replace(/,/g,'').replace(/\D/g,'');
  e.target.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,",");
});

function addCash(){
  cashRows.innerHTML+=`
  <tr>
    <td><input class="money cashAmount"></td>
    <td><input type="date" class="cashDate"></td>
    <td><button class="small-btn" onclick="this.closest('tr').remove()">âœ–</button></td>
  </tr>`;
}

function getCashTotal(){
  let sum=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{
    sum+=Number(i.value.replace(/,/g,''))||0;
  });
  return sum;
}

function daysInMonth(jy,jm){
  if(jm<=6)return 31;
  if(jm<=11)return 30;
  return (jy%4===3)?30:29;
}

function addMonths(jy,jm,jd,m){
  jm+=m;
  jy+=Math.floor((jm-1)/12);
  jm=((jm-1)%12)+1;
  let dim=daysInMonth(jy,jm);
  if(jd>dim)jd=dim;
  return `${jy}/${String(jm).padStart(2,'0')}/${String(jd).padStart(2,'0')}`;
}

function calc(){
  const totalInitial=area.value*pricePerMeter.value.replace(/,/g,'');
  const afterDiscount=totalInitial
    - (totalInitial*(Number(discountPercent.value)||0)/100)
    - (Number(discountAmount.value.replace(/,/g,''))||0);

  const cashTotal=getCashTotal();
  const doc=Number(doc.value.replace(/,/g,''))||0;
  const delivery=Number(delivery.value.replace(/,/g,''))||0;

  const net=afterDiscount-(cashTotal+doc+delivery);
  const base=net/(Number(count.value)||1);

  let sum=0;
  installments.innerHTML='';
  pInstallments.innerHTML='';

  const now=new Date();
  const j=jalaali.toJalaali(now.getFullYear(),now.getMonth()+1,now.getDate());

  for(let i=1;i<=count.value;i++){
    let inst=Math.round(base);
    sum+=inst;
    let d=addMonths(j.jy,j.jm,j.jd,i*(Number(gap.value)||1));
    installments.innerHTML+=`<tr><td>${i}</td><td>${inst.toLocaleString()}</td><td>${d}</td></tr>`;
    pInstallments.innerHTML+=`<tr><td>${i}</td><td>${inst.toLocaleString()}</td><td>${d}</td></tr>`;
  }

  sumInstallments.textContent=sum.toLocaleString();
  pSum.textContent=sum.toLocaleString();

  summary.textContent=`Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒØ·: ${net.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;

  pInitial.textContent=Number(totalInitial).toLocaleString();
  pAfterDiscount.textContent=Number(afterDiscount).toLocaleString();
  pDoc.textContent=doc.toLocaleString();
  pDelivery.textContent=delivery.toLocaleString();
  pNewTotal.textContent=(cashTotal+doc+delivery+sum).toLocaleString();

  pCashRows.innerHTML='';
  document.querySelectorAll('#cashRows tr').forEach(r=>{
    const m=r.querySelector('.cashAmount').value;
    const d=r.querySelector('.cashDate').value;
    if(m)
      pCashRows.innerHTML+=`<tr><td>${m}</td><td>${d}</td></tr>`;
  });
}
</script>

</body>
</html>
