<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</title>
<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:900px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px;border-radius:6px;border:1px solid #ccc}
input[readonly]{background:#f3f3f3}
button{background:#7b2cbf;color:#fff;border:none;cursor:pointer}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px;white-space:pre-line}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.print-only{display:none}
.small-btn{background:#999;font-size:12px}
@media print{
  body{background:#fff}
  .page{margin:0;padding:10px;font-size:12px;line-height:1.2;}
  .no-print{display:none !important}
  .print-only{display:block !important}
  .print-only, .print-only table, .print-only tr, .print-only td, .print-only th { page-break-inside: avoid; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>
<body>
<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h2>

<div class="row no-print">
  <div><input id="area" type="text" inputmode="numeric" pattern="\d*" placeholder="Ù…ØªØ±Ø§Ú˜"></div>
  <div><input id="pricePerMeter" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±"></div>
</div>

<input id="total" class="money no-print" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡" readonly>

<div class="row no-print">
  <div><input id="discountPercent" type="text" inputmode="numeric" pattern="\d*" placeholder="ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ"></div>
  <div><input id="discountAmount" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ"></div>
</div>

<input id="totalAfterDiscount" class="money no-print" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ®ÙÛŒÙ" readonly>

<div class="box no-print">
<b>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ</b>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th></th></tr></thead>
<tbody id="cashRows"></tbody>
</table>
<button onclick="addCash()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ</button>
<b>Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ:</b> <span id="cashSum">0</span> ØªÙˆÙ…Ø§Ù†
</div>

<div class="row no-print">
  <div><input id="delivery" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="ØªØ­ÙˆÛŒÙ„"></div>
  <div><input id="doc" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="Ø³Ù†Ø¯"></div>
</div>

<div class="row no-print">
  <div><input id="count" type="text" inputmode="numeric" pattern="\d*" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·"></div>
  <div><input id="gap" type="text" inputmode="numeric" pattern="\d*" placeholder="ÙØ§ØµÙ„Ù‡ Ø§Ù‚Ø³Ø§Ø· (Ù…Ø§Ù‡)"></div>
</div>

<input id="percent" class="no-print" type="text" inputmode="numeric" pattern="\d*" placeholder="Ø¯Ø±ØµØ¯ Ø§Ù‚Ø³Ø§Ø· (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)">
<input id="startDate" type="date" class="no-print">

<div style="font-size:12px;color:#555;margin-top:-4px;margin-bottom:6px">
ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø·: Ø±ÙˆØ²ÛŒ Ú©Ù‡ Ø§Ù‚Ø³Ø§Ø· Ø§Ø² Ø¢Ù† Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¯Ø± Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ Ù†ÛŒØ² Ø«Ø§Ø¨Øª Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.
</div>

<div class="row no-print">
  <div><button onclick="calc()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button></div>
  <div><button onclick="resetAll()" style="background:#f00;">Ø±ÛŒØ³Øª</button></div>
  <div><button onclick="window.print()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button></div>
</div>

<div id="netBox" class="box bold no-print"></div>
<div id="result" class="box no-print"></div>
<div id="equalBox" class="box bold no-print"></div>
<div id="totalPaymentBox" class="box bold no-print"></div>
<div id="newPriceBox" class="box bold no-print"></div>

<div class="box print-only">
Ù…ØªØ±Ø§Ú˜: <span id="pArea"></span> Ù…ØªØ±<br>
Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±: <span id="pPrice"></span> ØªÙˆÙ…Ø§Ù†<br>
Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡: <span id="pTotal"></span> ØªÙˆÙ…Ø§Ù†<br>
ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ: <span id="pDiscountPercent"></span>%<br>
ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ: <span id="pDiscountAmount"></span> ØªÙˆÙ…Ø§Ù†<br>
Ù…Ø¨Ù„Øº Ú©Ù„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ®ÙÛŒÙ: <span id="pTotalAfterDiscount"></span> ØªÙˆÙ…Ø§Ù†<br>

<b>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ:</b>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
<tbody id="pCashRows"></tbody>
</table>

ØªØ­ÙˆÛŒÙ„: <span id="pDelivery"></span> ØªÙˆÙ…Ø§Ù†<br>
Ø³Ù†Ø¯: <span id="pDoc"></span> ØªÙˆÙ…Ø§Ù†<br>

<b>Ù„ÛŒØ³Øª Ø§Ù‚Ø³Ø§Ø·:</b>
<div id="pInstallmentsList"></div>

<b>Ù‚Ø³Ø· Ù…Ø³Ø§ÙˆÛŒ:</b> <span id="pEqualInstallment"></span> ØªÙˆÙ…Ø§Ù†<br>

<b>Ù…Ø¨Ù„Øº Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ:</b> <span id="pTotalPayment"></span> ØªÙˆÙ…Ø§Ù†<br>
<b>Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ± Ø¬Ø¯ÛŒØ¯:</b> <span id="pNewPrice"></span> ØªÙˆÙ…Ø§Ù†
</div>

<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<script>
// Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ®
setInterval(()=>{
  const d=new Date();
  time.textContent=d.toLocaleTimeString('fa-IR');
  date.textContent=d.toLocaleDateString('fa-IR');
},1000);

// ØªØ¨Ø¯ÛŒÙ„ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ù‡ Ø¹Ø¯Ø¯
function num(val){ return Number((val||'').toString().replace(/,/g,''))||0; }

// ÙØ±Ù…Øª Ø³Ù‡â€ŒØ±Ù‚Ù…ÛŒ
function formatMoney(input){
  let value=input.value.replace(/,/g,'');
  if(!isNaN(value) && value!=='') input.value=Number(value).toLocaleString();
}

// Ø§Ø¹Ù…Ø§Ù„ ÙØ±Ù…Øª Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡
document.querySelectorAll('.money').forEach(input=>{
  input.addEventListener('input',function(){
    formatMoney(this);
    calculateTotals();
  });
});
area.addEventListener('input',calculateTotals);
pricePerMeter.addEventListener('input',calculateTotals);
discountPercent.addEventListener('input',calculateTotals);
discountAmount.addEventListener('input',calculateTotals);

function calculateTotals(){
  const areaVal=num(area.value);
  const priceVal=num(pricePerMeter.value);
  const totalVal=areaVal*priceVal;
  total.value=totalVal.toLocaleString();
  let discountVal=(totalVal*(num(discountPercent.value)/100)||0)+num(discountAmount.value);
  const finalTotal=totalVal-discountVal;
  totalAfterDiscount.value=finalTotal.toLocaleString();
}

// Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ
function addCash(){
  const row=document.createElement('tr');
  row.innerHTML=`<td><input class="money cashAmount" type="text" inputmode="numeric" pattern="\d*"></td>
                   <td><input type="date" class="cashDate"></td>
                   <td><button class="small-btn" onclick="this.closest('tr').remove();updateCashSum()">âœ–</button></td>`;
  document.getElementById('cashRows').appendChild(row);
  row.querySelector('.cashAmount').addEventListener('input',updateCashSum);
}

// Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ
function updateCashSum(){
  let sum=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{ sum+=num(i.value); });
  cashSum.textContent=sum.toLocaleString();
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§ØµÙ„ÛŒ
function calc(){
  const totalVal=num(totalAfterDiscount.value);
  const deliveryVal=num(delivery.value);
  const docVal=num(doc.value);
  const countVal=Number(count.value)||1;
  const gapVal=Number(gap.value)||1;

  let percentVal=0;
  if(percent.value.trim()===''){
    percentVal=(countVal*gapVal<=6?0.04:countVal*gapVal<=12?0.06:0.08);
    percent.value=(percentVal*100);
  }else percentVal=num(percent.value)/100;

  let cashTotal=0;
  document.querySelectorAll('.cashAmount').forEach(i=>cashTotal+=num(i.value));

  const net=totalVal-cashTotal-deliveryVal-docVal;
  netBox.textContent='Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒØ·: '+net.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  let sum=0,text='';
  const start=startDate.value||new Date().toISOString().split('T')[0];

  for(let i=1;i<=countVal;i++){
    let inst=net/countVal;
    inst+=inst*percentVal*i*gapVal;
    sum+=inst;
    text+=`Ù‚Ø³Ø· ${i}: ${Math.round(inst).toLocaleString()} ØªÙˆÙ…Ø§Ù†\n`;
  }

  result.textContent=text;

  const equal=Math.round(sum/countVal);
  equalBox.textContent='Ù‚Ø³Ø· Ù…Ø³Ø§ÙˆÛŒ: '+equal.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  const totalPayment=cashTotal+deliveryVal+docVal+sum;
  totalPaymentBox.textContent='Ù…Ø¨Ù„Øº Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: '+totalPayment.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';
  newPriceBox.textContent='Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ± Ø¬Ø¯ÛŒØ¯: '+Math.round(totalPayment/(num(area.value)||1)).toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  // Ù¾Ø±ÛŒÙ†Øª
  pArea.textContent=area.value;
  pPrice.textContent=num(pricePerMeter.value).toLocaleString();
  pTotal.textContent=num(total.value).toLocaleString();
  pTotalAfterDiscount.textContent=num(totalAfterDiscount.value).toLocaleString();
  pDiscountPercent.textContent=num(discountPercent.value);
  pDiscountAmount.textContent=num(discountAmount.value).toLocaleString();
  pDelivery.textContent=deliveryVal.toLocaleString();
  pDoc.textContent=docVal.toLocaleString();
  pInstallmentsList.textContent=text;
  pEqualInstallment.textContent=equal.toLocaleString();
  pTotalPayment.textContent=totalPayment.toLocaleString();
  pNewPrice.textContent=Math.round(totalPayment/(num(area.value)||1)).toLocaleString();
  updateCashSum();
}

// Ø±ÛŒØ³Øª
function resetAll(){
  document.querySelectorAll('input').forEach(i=>i.value='');
  document.querySelectorAll('#cashRows tr').forEach(r=>r.remove());
  document.querySelectorAll('.print-only span, .print-only div').forEach(e=>e.textContent='');
  netBox.textContent=result.textContent=equalBox.textContent=totalPaymentBox.textContent=newPriceBox.textContent='';
}

</script>
</body>
</html>
