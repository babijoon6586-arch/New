<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>پیش فاکتور فروش</title>
<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:900px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px;border-radius:6px;border:1px solid #ccc}
input[readonly]{background:#f3f3f3}
button{background:#7b2cbf;color:#fff;border:none;cursor:pointer}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px;white-space:pre-line}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.print-only{display:none}
.small-btn{background:#999;font-size:12px}
@media print{
  .no-print{display:none}
  .print-only{display:block}
  body{background:#fff}
  .page{margin:0}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>
<body>
<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>پیش فاکتور فروش</h2>

<!-- متراژ و قیمت هر متر -->
<div class="row no-print">
  <div><input id="area" type="text" inputmode="numeric" pattern="\d*" placeholder="متراژ"></div>
  <div><input id="pricePerMeter" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="قیمت هر متر"></div>
</div>

<input id="total" class="money no-print" placeholder="مبلغ کل اولیه" readonly>
<input id="totalAfterDiscount" class="money no-print" placeholder="مبلغ کل بعد از تخفیف" readonly>

<!-- واریزهای نقدی -->
<div class="box no-print">
<b>واریزهای نقدی</b>
<table>
<thead><tr><th>مبلغ</th><th>تاریخ</th><th></th></tr></thead>
<tbody id="cashRows"></tbody>
</table>
<button onclick="addCash()">➕ افزودن واریز نقدی</button>
<b>جمع واریزهای نقدی:</b> <span id="cashSum">0</span> تومان
</div>

<div class="row no-print">
  <div><input id="delivery" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="تحویل"></div>
  <div><input id="doc" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="سند"></div>
</div>

<div class="row no-print">
  <div><input id="discountPercent" type="text" inputmode="numeric" pattern="\d*" placeholder="تخفیف درصدی"></div>
  <div><input id="discountAmount" class="money" type="text" inputmode="numeric" pattern="\d*" placeholder="تخفیف مبلغی"></div>
</div>

<div class="row no-print">
  <div><input id="count" type="text" inputmode="numeric" pattern="\d*" placeholder="تعداد اقساط"></div>
  <div><input id="gap" type="text" inputmode="numeric" pattern="\d*" placeholder="فاصله اقساط (ماه)"></div>
</div>

<input id="percent" class="no-print" type="text" inputmode="numeric" pattern="\d*" placeholder="درصد اقساط (قابل تغییر)">
<input id="startDate" type="date" class="no-print">

<div class="row no-print">
  <div><button onclick="calc()">محاسبه</button></div>
  <div><button onclick="resetAll()" style="background:#f00;">ریست</button></div>
</div>

<div id="netBox" class="box bold"></div>
<div id="result" class="box"></div>
<div id="equalBox" class="box bold"></div>
<div id="totalPaymentBox" class="box bold"></div>
<div id="newPriceBox" class="box bold"></div>

<!-- پرینت -->
<div class="box print-only">
متراژ: <span id="pArea"></span> متر<br>
قیمت هر متر اولیه: <span id="pPrice"></span> تومان<br>
مبلغ کل اولیه: <span id="pTotal"></span> تومان<br>
مبلغ کل بعد از تخفیف: <span id="pTotalAfterDiscount"></span> تومان<br>
تخفیف درصدی: <span id="pDiscountPercent"></span>%<br>
تخفیف مبلغی: <span id="pDiscountAmount"></span> تومان<br>
سند: <span id="pDoc"></span> تومان<br>
تحویل: <span id="pDelivery"></span> تومان<br>
<b>واریزهای نقدی:</b>
<table>
<thead><tr><th>مبلغ</th><th>تاریخ</th></tr></thead>
<tbody id="pCashRows"></tbody>
</table>
<b>جمع واریزهای نقدی:</b> <span id="pCashSum"></span> تومان<br>
مبلغ قابل تقسیط: <span id="pNet"></span> تومان<br>
قسط مساوی: <span id="pInstallment"></span> تومان<br>
تاریخ شروع اقساط: <span id="pStart"></span><br>
<b>لیست اقساط:</b>
<div id="pInstallmentsList"></div>
<b>مبلغ کل پرداختی:</b> <span id="pTotalPayment"></span> تومان<br>
<b>قیمت هر متر جدید:</b> <span id="pNewPrice"></span> تومان
</div>

</div>

<script>
setInterval(()=>{
  const d=new Date();
  time.textContent=d.toLocaleTimeString('fa-IR');
  date.textContent=d.toLocaleDateString('fa-IR');
},1000);

document.addEventListener('input', e=>{
  if(!e.target.classList.contains('money')) return;
  let v=e.target.value.replace(/,/g,'').replace(/\D/g,'');
  e.target.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,",");
});

function num(val){ return Number((val||'').toString().replace(/,/g,''))||0; }

area.oninput=pricePerMeter.oninput=()=>{
  const t=(Number(area.value)||0)*num(pricePerMeter.value);
  total.value=t?t.toLocaleString():'';
}

function toJalali(dateStr){
  if(!dateStr) return '-';
  const g=new Date(dateStr);
  const j=jalaali.toJalaali(g.getFullYear(),g.getMonth()+1,g.getDate());
  return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
}

function isLeap(jy){
  return ((jy%33==1)||(jy%33==5)||(jy%33==9)||(jy%33==13)||(jy%33==17)||(jy%33==22)||(jy%33==26)||(jy%33==30));
}

function addMonthsJalaliFixed(dateStr, months){
  let g;
  if(!dateStr) g = new Date();
  else { g = new Date(dateStr+'T00:00'); }
  let j = jalaali.toJalaali(g.getFullYear(), g.getMonth()+1, g.getDate());
  let jy = j.jy, jm = j.jm + months, jd = j.jd;
  jy += Math.floor((jm-1)/12);
  jm = ((jm-1)%12)+1;
  let daysInMonth = jm<=6?31:(jm<=11?30:(isLeap(jy)?30:29));
  if(jd>daysInMonth) jd=daysInMonth;
  const g2= jalaali.toGregorian(jy,jm,jd);
  return toJalali(new Date(g2.gy,g2.gm-1,g2.gd).toLocaleDateString('sv-SE'));
}

function addCash(){
  const row = document.createElement('tr');
  row.innerHTML = `<td><input class="money cashAmount" type="text" inputmode="numeric" pattern="\d*"></td>
                   <td><input type="date" class="cashDate"></td>
                   <td><button class="small-btn" onclick="this.closest('tr').remove();updateCashSum()">✖</button></td>`;
  document.getElementById('cashRows').appendChild(row);
  row.querySelector('.cashAmount').addEventListener('input', updateCashSum);
}

function updateCashSum(){
  let sum=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{ sum+=num(i.value); });
  cashSum.textContent=sum.toLocaleString();
  pCashSum.textContent=sum.toLocaleString();
}

// محاسبه لحظه‌ای درصد اقساط هنگام تغییر تعداد یا فاصله
[count,gap].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(document.getElementById('percent').value.trim()===''){
      const c = Number(count.value)||1;
      const g = Number(gap.value)||1;
      let val = (c*g<=6?0.04:c*g<=12?0.06:0.08);
      document.getElementById('percent').value = (val*100).toLocaleString();
    }
  });
});

function calc(){
  const totalVal=num(total.value);
  const delivery=num('delivery'), doc=num('doc');
  const discountPercent=num('discountPercent')||0;
  const discountAmount=num('discountAmount')||0;
  const countVal=Number(count.value)||1;
  const gapVal=Number(gap.value)||1;

  let percentVal;
  const percentInput=document.getElementById('percent');
  if(percentInput.value.trim()===''){
    percentVal = (countVal*gapVal<=6?0.04:countVal*gapVal<=12?0.06:0.08);
    percentInput.value=(percentVal*100).toLocaleString();
  } else percentVal=num('percent')/100;

  let cashTotal=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{ cashTotal+=num(i.value); });

  const afterDiscount = totalVal - (totalVal*discountPercent/100) - discountAmount;
  totalAfterDiscount.value = afterDiscount.toLocaleString();

  const net = afterDiscount - (cashTotal + delivery + doc);
  netBox.textContent='مبلغ قابل تقسیط: '+net.toLocaleString()+' تومان';

  const base = net/countVal;
  let sum = 0, text='';
  const start = startDate.value || new Date().toISOString().split('T')[0];

  for(let i=1;i<=countVal;i++){
    let inst=base;
    if(i>=1) inst+=base*percentVal*i*gapVal;
    sum+=inst;
    const instDate=addMonthsJalaliFixed(start,(i-1)*gapVal);
    text+=`قسط ${i}: ${Math.round(inst).toLocaleString()} تومان — تاریخ: ${instDate}\n`;
  }

  result.textContent=text;
  equalBox.textContent='قسط مساوی: '+Math.round(sum/countVal).toLocaleString()+' تومان';

  const totalPayment = cashTotal + delivery + doc + sum;
  totalPaymentBox.textContent = 'مبلغ کل پرداختی: '+totalPayment.toLocaleString()+' تومان';
  const areaVal = num(area.value)||1;
  newPriceBox.textContent = 'قیمت هر متر جدید: '+Math.round(totalPayment/areaVal).toLocaleString()+' تومان';

  // پرینت
  pArea.textContent=area.value;
  pPrice.textContent=num(pricePerMeter.value).toLocaleString();
  pTotal.textContent=totalVal.toLocaleString();
  pTotalAfterDiscount.textContent=afterDiscount.toLocaleString();
  pDiscountPercent.textContent=discountPercent;
  pDiscountAmount.textContent=discountAmount.toLocaleString();
  pDoc.textContent=doc.toLocaleString();
  pDelivery.textContent=delivery.toLocaleString();
  pNet.textContent=net.toLocaleString();
  pInstallment.textContent=Math.round(sum/countVal).toLocaleString();
  pStart.textContent=toJalali(start);
  pInstallmentsList.textContent=text;
  pTotalPayment.textContent = totalPayment.toLocaleString();
  pNewPrice.textContent = Math.round(totalPayment/areaVal).toLocaleString();

  const pCashBody = document.getElementById('pCashRows');
  pCashBody.innerHTML='';
  document.querySelectorAll('#cashRows tr').forEach(r=>{
    const m = r.querySelector('.cashAmount')?.value;
    const d = r.querySelector('.cashDate')?.value;
    if(m && d){
      pCashBody.innerHTML+=`<tr><td>${num(m).toLocaleString()}</td><td>${toJalali(d)}</td></tr>`;
    }
  });
  updateCashSum();
}

// ریست کامل
function resetAll(){
  document.querySelectorAll('input').forEach(i=>{
    if(i.type!=='button') i.value='';
  });
  document.querySelectorAll('#cashRows tr').forEach(r=>r.remove());
  cashSum.textContent='0';
  netBox.textContent='';
  result.textContent='';
  equalBox.textContent='';
  totalPaymentBox.textContent='';
  newPriceBox.textContent='';
  document.querySelectorAll('.print-only span, .print-only div').forEach(e=>{
    e.textContent='';
  });
}
</script>
</body>
</html>
