<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</title>

<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:900px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px;border-radius:6px;border:1px solid #ccc}
input[readonly]{background:#f3f3f3}
button{background:#7b2cbf;color:#fff;border:none;cursor:pointer}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px;white-space:pre-line}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.print-only{display:none}
.small-btn{background:#999;font-size:12px}
@media print{
  .no-print{display:none}
  .print-only{display:block}
  body{background:#fff}
  .page{margin:0}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>

<body>

<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h2>

<!-- Ù…ØªØ±Ø§Ú˜ -->
<div class="row no-print">
  <div><input id="area" placeholder="Ù…ØªØ±Ø§Ú˜"></div>
  <div><input id="pricePerMeter" class="money" placeholder="Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±"></div>
</div>

<input id="total" class="money no-print" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„" readonly>

<!-- ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ -->
<div class="box no-print">
<b>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ</b>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th><th></th></tr></thead>
<tbody id="cashRows"></tbody>
</table>
<button onclick="addCash()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ</button>
<b>Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ:</b> <span id="cashSum">0</span> ØªÙˆÙ…Ø§Ù†
</div>

<!-- Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± -->
<div class="row no-print">
  <div><input id="delivery" class="money" placeholder="ØªØ­ÙˆÛŒÙ„"></div>
  <div><input id="doc" class="money" placeholder="Ø³Ù†Ø¯"></div>
</div>

<div class="row no-print">
  <div><input id="discountPercent" placeholder="ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ"></div>
  <div><input id="discountAmount" class="money" placeholder="ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ"></div>
</div>

<div class="row no-print">
  <div><input id="count" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·"></div>
  <div><input id="gap" placeholder="ÙØ§ØµÙ„Ù‡ Ø§Ù‚Ø³Ø§Ø· (Ù…Ø§Ù‡)"></div>
</div>

<input id="percent" class="no-print" placeholder="Ø¯Ø±ØµØ¯ Ø§Ù‚Ø³Ø§Ø· (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)">
<input id="startDate" type="date" class="no-print">

<button onclick="calc()" class="no-print">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
<button onclick="window.print()" class="no-print">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>

<div id="netBox" class="box bold"></div>
<div id="result" class="box"></div>
<div id="equalBox" class="box bold"></div>

<!-- Ù¾Ø±ÛŒÙ†Øª -->
<div class="box print-only">
Ù…ØªØ±Ø§Ú˜: <span id="pArea"></span> Ù…ØªØ±<br>
Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±: <span id="pPrice"></span> ØªÙˆÙ…Ø§Ù†<br>
Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡: <span id="pTotal"></span> ØªÙˆÙ…Ø§Ù†<br>
ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ: <span id="pDiscountPercent"></span>%<br>
ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ: <span id="pDiscountAmount"></span> ØªÙˆÙ…Ø§Ù†<br>
Ø³Ù†Ø¯: <span id="pDoc"></span> ØªÙˆÙ…Ø§Ù†<br>
ØªØ­ÙˆÛŒÙ„: <span id="pDelivery"></span> ØªÙˆÙ…Ø§Ù†<br>
<b>ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ:</b>
<table>
<thead><tr><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr></thead>
<tbody id="pCashRows"></tbody>
</table>
<b>Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ:</b> <span id="pCashSum"></span> ØªÙˆÙ…Ø§Ù†<br>
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒØ·: <span id="pNet"></span> ØªÙˆÙ…Ø§Ù†<br>
Ù‚Ø³Ø· Ù…Ø³Ø§ÙˆÛŒ: <span id="pInstallment"></span> ØªÙˆÙ…Ø§Ù†<br>
ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø·: <span id="pStart"></span><br>
<div id="pInstallmentsList"></div>
</div>

</div>

<script>
// ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø´Ù…Ø³ÛŒ
setInterval(()=>{
  const d=new Date();
  time.textContent=d.toLocaleTimeString('fa-IR');
  date.textContent=d.toLocaleDateString('fa-IR');
},1000);

// Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø³Ù‡â€ŒØ±Ù‚Ù…ÛŒ
document.addEventListener('input',e=>{
  if(!e.target.classList.contains('money')) return;
  let v=e.target.value.replace(/,/g,'').replace(/\D/g,'');
  e.target.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,",");
});

function num(id){
  const el=document.getElementById(id);
  return el && el.value ? Number(el.value.replace(/,/g,''))||0 : 0;
}

// Ù…Ø¨Ù„Øº Ú©Ù„
area.oninput=pricePerMeter.oninput=()=>{
  const t=(Number(area.value)||0)*num('pricePerMeter');
  total.value=t?t.toLocaleString():'';
};

// Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ
function addCash(){
 cashRows.innerHTML+=`
 <tr>
  <td><input class="money cashAmount"></td>
  <td><input type="date" class="cashDate"></td>
  <td><button class="small-btn" onclick="this.closest('tr').remove();updateCashSum()">âœ–</button></td>
 </tr>`;
}

// Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ
function updateCashSum(){
  let sum=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{
    sum+=Number(i.value.replace(/,/g,''))||0;
  });
  cashSum.textContent=sum.toLocaleString();
  pCashSum.textContent=sum.toLocaleString();
}

// ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function toJalali(dateStr){
  if(!dateStr) return '-';
  const g=new Date(dateStr);
  const j=jalaali.toJalaali(g.getFullYear(),g.getMonth()+1,g.getDate());
  return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
}

// Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ø§ Ø±ÙˆØ² Ø«Ø§Ø¨Øª
function addMonthsJalali(dateStr,months){
  if(!dateStr) dateStr = new Date().toISOString().split('T')[0];
  const g=new Date(dateStr);
  const j=jalaali.toJalaali(g.getFullYear(),g.getMonth()+1,g.getDate());
  let jy=j.jy,jm=j.jm+months,jd=j.jd;
  jy+=Math.floor((jm-1)/12);
  jm=((jm-1)%12)+1;
  const g2=jalaali.toGregorian(jy,jm,jd);
  return toJalali(new Date(g2.gy,g2.gm-1,jd).toISOString().split('T')[0]);
}

function calc(){
  const totalVal=num('total');
  const delivery=num('delivery'),doc=num('doc');
  const discountPercent=num('discountPercent')||0;
  const discountAmount=num('discountAmount')||0;
  const countVal=Number(count.value)||1;
  const gapVal=Number(gap.value)||1;

  let percentVal;
  if(percent.value){
    percentVal=Number(percent.value)/100;
  }else{
    const d=countVal*gapVal;
    percentVal=d<=6?0.04:d<=12?0.06:0.08;
    percent.value=percentVal*100;
  }

  // Ø¬Ù…Ø¹ ÙˆØ§Ø±ÛŒØ² Ù†Ù‚Ø¯ÛŒ
  let cashTotal=0;
  document.querySelectorAll('.cashAmount').forEach(i=>{
    cashTotal+=Number(i.value.replace(/,/g,''))||0;
  });

  const afterDiscount = totalVal - (totalVal*discountPercent/100) - discountAmount;
  const net = afterDiscount - (cashTotal + delivery + doc);
  netBox.textContent='Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒØ·: '+net.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  const base = net / countVal;
  let sum = 0;
  let text = '';

  const start = startDate.value || new Date().toISOString().split('T')[0];

  for(let i=1;i<=countVal;i++){
    let inst = base;
    if(i>=1) inst += base*percentVal*i*gapVal;
    sum += inst;

    const instDate = addMonthsJalali(start,(i-1)*gapVal);
    text += `Ù‚Ø³Ø· ${i}: ${Math.round(inst).toLocaleString()} ØªÙˆÙ…Ø§Ù† â€” ØªØ§Ø±ÛŒØ®: ${instDate}\n`;
  }

  result.textContent=text;
  const equal=Math.round(sum/countVal);
  equalBox.textContent='Ù‚Ø³Ø· Ù…Ø³Ø§ÙˆÛŒ: '+equal.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  // Ù¾Ø±ÛŒÙ†Øª
  pArea.textContent=area.value;
  pPrice.textContent=num('pricePerMeter').toLocaleString();
  pTotal.textContent=totalVal.toLocaleString();
  pDiscountPercent.textContent=discountPercent;
  pDiscountAmount.textContent=discountAmount.toLocaleString();
  pDoc.textContent=doc.toLocaleString();
  pDelivery.textContent=delivery.toLocaleString();
  pNet.textContent=net.toLocaleString();
  pInstallment.textContent=equal.toLocaleString();
  pStart.textContent=toJalali(start);
  pInstallmentsList.textContent=text;

  // ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ Ù†Ù‚Ø¯ÛŒ Ø¯Ø± Ù¾Ø±ÛŒÙ†Øª
  const pCashBody = document.getElementById('pCashRows');
  pCashBody.innerHTML='';
  document.querySelectorAll('#cashRows tr').forEach(r=>{
    const m = r.querySelector('.cashAmount')?.value;
    const d = r.querySelector('.cashDate')?.value;
    if(m && d){
      pCashBody.innerHTML += `<tr><td>${Number(m.replace(/,/g,'')).toLocaleString()}</td><td>${toJalali(d)}</td></tr>`;
    }
  });
  pCashSum.textContent=cashTotal.toLocaleString();
}
</script>

</body>
</html>
