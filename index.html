<script>
function calc(){

  const totalVal = num('total');
  const cash = num('cash');
  const delivery = num('delivery');
  const doc = num('doc');

  const count = Number(document.getElementById('count').value) || 1;
  const gap = Number(document.getElementById('gap').value) || 1;
  const areaVal = Number(document.getElementById('area').value) || 1;

  // درصد دستی یا خودکار
  let percentInput = document.getElementById('percent').value;
  let percent;

  if(percentInput){
    percent = Number(percentInput) / 100;
  }else{
    let duration = count * gap;
    percent = duration <= 6 ? 0.04 : duration <= 12 ? 0.06 : 0.08;
    document.getElementById('percent').value = percent * 100;
  }

  // مبلغ قابل تقسیط
  const net = totalVal - (cash + delivery + doc);
  document.getElementById('netBox').textContent =
    'مبلغ قابل تقسیط: ' + net.toLocaleString() + ' تومان';

  const base = net / count;

  let resultText = '';
  let sumInstallments = 0;

  for(let i = 1; i <= count; i++){
    let inst = base;
    if(i >= 1){
      inst += base * percent * i * gap;
    }
    sumInstallments += inst;
    resultText += `قسط ${i}: ${Math.round(inst).toLocaleString()} تومان\n`;
  }

  document.getElementById('result').textContent = resultText;

  // قسط مساوی
  const equalInstallment = sumInstallments / count;
  document.getElementById('equalBox').textContent =
    'قسط مساوی (نمایشی): ' +
    Math.round(equalInstallment).toLocaleString() + ' تومان';

  // جمع کل پرداختی
  const totalPaid = sumInstallments + cash + delivery + doc;
  const finalPricePerMeter = totalPaid / areaVal;

  document.getElementById('sumBox').textContent =
    'جمع کل پرداختی: ' + Math.round(totalPaid).toLocaleString() + ' تومان\n' +
    'قیمت هر متر نهایی: ' + Math.round(finalPricePerMeter).toLocaleString() + ' تومان';
}
</script>
