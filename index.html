function printInvoice() {

    const metraj = Number(document.getElementById("metraj").value) || 0;
    const gheymatHarMetr = Number(document.getElementById("pricePerMeter").value) || 0;

    const mablaghKol = metraj * gheymatHarMetr;

    const darsadTakhfif = Number(document.getElementById("discountPercent").value) || 0;
    const mablaghTakhfif = Number(document.getElementById("discountAmount").value) || 0;

    const takhfifPercentAmount = (mablaghKol * darsadTakhfif) / 100;

    const mablaghKolBaTakhfif = mablaghKol - takhfifPercentAmount - mablaghTakhfif;

    const tahvil = Number(document.getElementById("tahvil").value) || 0;
    const sanad = Number(document.getElementById("sanad").value) || 0;

    const cashList = document.querySelectorAll(".cash-amount");
    const cashDateList = document.querySelectorAll(".cash-date");

    let cashHtml = "";
    let totalCash = 0;

    cashList.forEach((item, index) => {
        const amount = Number(item.value) || 0;
        const date = cashDateList[index].value || "-";

        if (amount > 0) {
            totalCash += amount;

            cashHtml += `
            <tr>
                <td style="border:1px solid #000;padding:4px">${index + 1}</td>
                <td style="border:1px solid #000;padding:4px">${date}</td>
                <td style="border:1px solid #000;padding:4px">${formatNumber(amount)}</td>
            </tr>
            `;
        }
    });

    const installmentsCount = Number(document.getElementById("installmentCount").value) || 0;

    const mablaghGhabelTaghsit =
        mablaghKolBaTakhfif - totalCash - tahvil - sanad;

    const eachInstallment =
        installmentsCount > 0
            ? Math.floor(mablaghGhabelTaghsit / installmentsCount)
            : 0;

    let installmentsHtml = "";
    const installmentDates = window.installmentDates || [];

    installmentDates.forEach((date, index) => {
        installmentsHtml += `
        <tr>
            <td style="border:1px solid #000;padding:4px">${index + 1}</td>
            <td style="border:1px solid #000;padding:4px">${date}</td>
            <td style="border:1px solid #000;padding:4px">${formatNumber(eachInstallment)}</td>
        </tr>
        `;
    });

    const mablaghKolPardakhti =
        totalCash +
        tahvil +
        sanad +
        (eachInstallment * installmentsCount);

    const gheymatHarMetrJadid =
        metraj > 0 ? Math.floor(mablaghKolPardakhti / metraj) : 0;

    const printContent = `
    <div style="direction:rtl;font-family:tahoma;font-size:12px">

        <p><b>متراژ:</b> ${metraj}</p>
        <p><b>قیمت هر متر:</b> ${formatNumber(gheymatHarMetr)}</p>
        <p><b>مبلغ کل اولیه:</b> ${formatNumber(mablaghKol)}</p>

        <p><b>تخفیف درصدی:</b> ${darsadTakhfif} %</p>
        <p><b>تخفیف مبلغی:</b> ${formatNumber(mablaghTakhfif)}</p>

        <p><b>مبلغ کل بعد از تخفیف:</b> ${formatNumber(mablaghKolBaTakhfif)}</p>

        <h4>مبالغ نقدی</h4>
        <table style="width:100%;border-collapse:collapse;font-size:11px">
            <tr>
                <th style="border:1px solid #000">ردیف</th>
                <th style="border:1px solid #000">تاریخ</th>
                <th style="border:1px solid #000">مبلغ</th>
            </tr>
            ${cashHtml}
        </table>

        <p><b>جمع واریز نقدی:</b> ${formatNumber(totalCash)}</p>

        <p><b>تحویل:</b> ${formatNumber(tahvil)}</p>
        <p><b>سند:</b> ${formatNumber(sanad)}</p>

        <h4>لیست اقساط</h4>
        <table style="width:100%;border-collapse:collapse;font-size:11px">
            <tr>
                <th style="border:1px solid #000">ردیف</th>
                <th style="border:1px solid #000">تاریخ</th>
                <th style="border:1px solid #000">مبلغ هر قسط (مساوی)</th>
            </tr>
            ${installmentsHtml}
        </table>

        <p><b>مبلغ کل پرداختی:</b> ${formatNumber(mablaghKolPardakhti)}</p>
        <p><b>قیمت هر متر جدید:</b> ${formatNumber(gheymatHarMetrJadid)}</p>

    </div>
    `;

    const newWindow = window.open("", "", "width=800,height=600");
    newWindow.document.write(`
        <html>
        <head>
            <title>پرینت</title>
            <style>
                @media print {
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
        ${printContent}
        </body>
        </html>
    `);

    newWindow.document.close();
    newWindow.print();
}
