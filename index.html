<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</title>
<style>
body{font-family:tahoma;direction:rtl;background:#eee;margin:0}
.page{background:#fff;max-width:900px;margin:10px auto;padding:20px}
h2{text-align:center}
.topbar{display:flex;justify-content:space-between;font-size:14px;margin-bottom:10px}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px;border-radius:6px;border:1px solid #ccc}
input[readonly]{background:#f3f3f3}
button{background:#7b2cbf;color:#fff;border:none}
.row{display:flex;gap:10px}
.row>div{flex:1}
.box{border:1px solid #ddd;padding:10px;margin-top:10px;border-radius:6px;white-space:pre-line}
.bold{font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
table,th,td{border:1px solid #ddd}
th,td{padding:6px;text-align:center}
.print-only{display:none}
@media print{
  button,.no-print{display:none}
  .print-only{display:block}
  body{background:#fff}
  .page{margin:0}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
</head>
<body>

<div class="page">

<div class="topbar">
  <div id="date"></div>
  <div id="time"></div>
</div>

<h2>Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</h2>

<div class="row no-print">
  <div><input id="area" placeholder="Ù…ØªØ±Ø§Ú˜"></div>
  <div><input id="pricePerMeter" class="money" placeholder="Ù‚ÛŒÙ…Øª Ù‡Ø± Ù…ØªØ±"></div>
</div>

<input id="total" class="money no-print" placeholder="Ù…Ø¨Ù„Øº Ú©Ù„" readonly>

<div class="row no-print">
  <div><input id="discountPercent" placeholder="ØªØ®ÙÛŒÙ Ø¯Ø±ØµØ¯ÛŒ (%)"></div>
  <div><input id="discountAmount" class="money" placeholder="ØªØ®ÙÛŒÙ Ù…Ø¨Ù„ØºÛŒ"></div>
</div>

<div class="row no-print">
  <div><input id="cash" class="money" placeholder="Ù†Ù‚Ø¯ÛŒ"></div>
  <div><input id="delivery" class="money" placeholder="ØªØ­ÙˆÛŒÙ„"></div>
  <div><input id="doc" class="money" placeholder="Ø³Ù†Ø¯"></div>
</div>

<div class="row no-print">
  <div><input id="count" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·"></div>
  <div><input id="gap" placeholder="ÙØ§ØµÙ„Ù‡ Ø§Ù‚Ø³Ø§Ø· (Ù…Ø§Ù‡)"></div>
</div>

<input id="percent" class="no-print" placeholder="Ø¯Ø±ØµØ¯ Ø§Ù‚Ø³Ø§Ø· (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)">
<button onclick="calc()" class="no-print">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
<button onclick="window.print()" class="no-print">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>

<div id="netBox" class="box bold"></div>
<div id="result" class="box"></div>
<div id="equalBox" class="box bold"></div>

<div class="box">
<h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ù‚Ø³Ø§Ø·</h3>
<div>Ù…Ø¨Ù„Øº Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡: <span id="mainTotalInitial"></span> ØªÙˆÙ…Ø§Ù†</div>
<div>Ù…Ø¨Ù„Øº Ú©Ù„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ®ÙÛŒÙ: <span id="mainTotalAfterDiscount"></span> ØªÙˆÙ…Ø§Ù†</div>
<div>Ù…Ø¨Ù„Øº Ú©Ù„ Ø¬Ø¯ÛŒØ¯ (Ù†Ù‚Ø¯+Ø³Ù†Ø¯+ØªØ­ÙˆÛŒÙ„+Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø·): <span id="mainNewTotal"></span> ØªÙˆÙ…Ø§Ù†</div>
<table>
<thead>
<tr><th>Ù‚Ø³Ø·</th><th>Ù…Ø¨Ù„Øº</th><th>ØªØ§Ø±ÛŒØ®</th></tr>
</thead>
<tbody id="mainInstallmentsTable"></tbody>
<tfoot>
<tr><th>Ø¬Ù…Ø¹ Ú©Ù„</th><th colspan="2" id="mainTotalInstallments"></th></tr>
</tfoot>
</table>
</div>

</div>

<script>
setInterval(()=>{
  const d=new Date();
  time.textContent=d.toLocaleTimeString('fa-IR');
  date.textContent=d.toLocaleDateString('fa-IR');
},1000);

document.addEventListener('input',e=>{
  if(!e.target.classList.contains('money')) return;
  let v=e.target.value.replace(/,/g,'').replace(/\D/g,'');
  e.target.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,",");
});

function num(id){
  const el=document.getElementById(id);
  return el && el.value ? Number(el.value.replace(/,/g,''))||0 : 0;
}

area.oninput=pricePerMeter.oninput=()=>{
  const t=(Number(area.value)||0)*num('pricePerMeter');
  total.value=t?t.toLocaleString():'';
};

function addMonthsJalaali(jy,jm,jd,months){
  jm += months;
  jy += Math.floor((jm-1)/12);
  jm = ((jm-1)%12)+1;
  // Ø±ÙˆØ² Ø«Ø§Ø¨Øª Ø¨Ø§ Ø±Ø¹Ø§ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ù…Ø§Ù‡
  const daysInMonth = jm<=6?31:(jm<=11?30:((jy%4===3)?30:29));
  if(jd>daysInMonth) jd=daysInMonth;
  return {jy,jm,jd};
}

function toJalaliStr(jy,jm,jd){return `${jy}/${String(jm).padStart(2,'0')}/${String(jd).padStart(2,'0')}`;}

function calc(){
  const areaVal = Number(area.value)||0;
  const pricePerMeterVal = num('pricePerMeter');
  const totalInitial = areaVal*pricePerMeterVal;

  const discountP = Number(discountPercent.value)||0;
  const discountA = num('discountAmount')||0;
  const totalAfterDiscount = totalInitial - (totalInitial*discountP/100) - discountA;

  const cash=num('cash'),delivery=num('delivery'),doc=num('doc');
  const countVal=Number(count.value)||1;
  const gapVal=Number(gap.value)||1;
  const percentVal = percent.value ? Number(percent.value)/100 : ((countVal*gapVal)<=6?0.04:(countVal*gapVal)<=12?0.06:0.08);

  const net = totalAfterDiscount - (cash+delivery+doc);
  netBox.textContent='Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒØ·: '+net.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  const base = net/countVal;
  let sum=0;

  const today = new Date();
  let {jy,jm,jd} = jalaali.toJalaali(today.getFullYear(),today.getMonth()+1,today.getDate());

  const installmentsTable=[];
  for(let i=1;i<=countVal;i++){
    let inst=base + base*percentVal*i*gapVal;
    sum+=inst;

    const newDate = addMonthsJalaali(jy,jm,jd,i*gapVal);
    installmentsTable.push({num:i,amount:Math.round(inst).toLocaleString(),date:toJalaliStr(newDate.jy,newDate.jm,newDate.jd)});
  }

  const equal=Math.round(sum/countVal);
  equalBox.textContent='Ù‚Ø³Ø· Ù…Ø³Ø§ÙˆÛŒ: '+equal.toLocaleString()+' ØªÙˆÙ…Ø§Ù†';

  const newTotal = cash+delivery+doc+Math.round(sum);

  document.getElementById('mainTotalInitial').textContent = totalInitial.toLocaleString();
  document.getElementById('mainTotalAfterDiscount').textContent = totalAfterDiscount.toLocaleString();
  document.getElementById('mainNewTotal').textContent = newTotal.toLocaleString();

  const tbody = document.getElementById('mainInstallmentsTable');
  tbody.innerHTML='';
  installmentsTable.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${row.num}</td><td>${row.amount}</td><td>${row.date}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('mainTotalInstallments').textContent = Math.round(sum).toLocaleString();
}
</script>

</body>
</html>
